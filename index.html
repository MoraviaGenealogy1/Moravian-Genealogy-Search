<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Moravian Genealogy Search</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 1em;
    }

    .tab-button {
      padding: 0.5em 1em;
      margin-right: 0.3em;
      border: 1px solid #aaa;
      background-color: #f0f0f0;
      cursor: pointer;
      font-size: 0.9em;
    }

    .tab-button.active {
      background-color: #dfefff;
      border-color: #66a;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1em;
    }

    th, td {
      border: 1px solid #aaa;
      padding: 0.5em;
      text-align: left;
    }

    input, select {
      margin-right: 1em;
      margin-top: 0.5em;
      padding: 0.3em;
    }

    #results {
      margin-top: 1em;
    }
  </style>
</head>
<body>
  <!-- HOME -->
  <div id="homeSection">
    <h2>Welcome to Moravian Genealogy Search</h2>
    <p>Search historical birth, marriage, and death records from Moravia by surname and region.</p>
    <button onclick="startSearch()">Begin Search</button>
  </div>

  <!-- SEARCH -->
  <div id="searchSection" style="display: none;">
    <!-- Tabs -->
    <div id="tabs" style="margin-bottom: 1em;">
      <button onclick="setTypeFilter('')" class="tab-button active">üìã All</button>
      <button onclick="setTypeFilter('Narozen√≠')" class="tab-button">üçº Births</button>
      <button onclick="setTypeFilter('S≈àatek')" class="tab-button">üíç Marriages</button>
      <button onclick="setTypeFilter('√ömrt√≠')" class="tab-button">‚ö∞Ô∏è Deaths</button>
    </div>

    <!-- Filters -->
    <label for="surname">P≈ô√≠jmen√≠ / Surname:</label>
    <input type="text" id="surname" placeholder="e.g. Novak" oninput="searchRecords()" />

    <label for="region">Farnost / Parish:</label>
    <select id="region" onchange="searchRecords()">
      <option value="">V≈°echny / All</option>
    </select>

    <!-- Results Table -->
    <table id="results">
      <thead>
        <tr>
          <th>Jm√©no</th>
          <th>P≈ô√≠jmen√≠</th>
          <th>Farnost</th>
          <th>Rok</th>
          <th>Druh</th>
          <th>Z√°znam</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    let records = [];
    let currentTypeFilter = '';

    function normalizeString(str) {
      return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
    }

    async function loadData() {
      try {
        const response = await fetch("records.json?t=" + new Date().getTime());
        records = await response.json();

        const regionSet = new Set();
        records.forEach(record => {
          if (record.parish) regionSet.add(record.parish);
        });

        const regionSelect = document.getElementById("region");
        for (const region of [...regionSet].sort()) {
          const option = document.createElement("option");
          option.value = region;
          option.textContent = region;
          regionSelect.appendChild(option);
        }

      } catch (e) {
        alert("Failed to load records.json: " + e.message);
      }
    }

    function startSearch() {
      document.getElementById("homeSection").style.display = "none";
      document.getElementById("searchSection").style.display = "block";
      setTypeFilter("");
    }

    function setTypeFilter(type) {
      currentTypeFilter = type;
      searchRecords();

      document.querySelectorAll(".tab-button").forEach(btn => {
        btn.classList.remove("active");
      });

      const tabButtons = {
        "": "üìã All",
        "Narozen√≠": "üçº Births",
        "S≈àatek": "üíç Marriages",
        "√ömrt√≠": "‚ö∞Ô∏è Deaths"
      };

      document.querySelectorAll(".tab-button").forEach(btn => {
        if (btn.textContent.includes(tabButtons[type])) {
          btn.classList.add("active");
        }
      });
    }

    function searchRecords() {
      const surnameQuery = document.getElementById("surname").value;
      const regionQuery = document.getElementById("region").value;
      const tbody = document.querySelector("#results tbody");
      tbody.innerHTML = '';

      const filtered = records.filter(record => {
        const surnameMatch = normalizeString(record.surname).includes(normalizeString(surnameQuery));
        const regionMatch = regionQuery === '' || record.parish === regionQuery;
        const typeMatch = currentTypeFilter === '' || record.type === currentTypeFilter;
        return surnameMatch && regionMatch && typeMatch;
      });

      filtered.sort((a, b) => Number(a.year) - Number(b.year));

      if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6">≈Ω√°dn√© v√Ωsledky nenalezeny / No results found.</td></tr>';
        return;
      }

      for (const record of filtered) {
        const row = `
          <tr>
            <td>${record.firstName}</td>
            <td>${record.surname}</td>
            <td>${record.parish}</td>
            <td>${record.year}</td>
            <td>${record.type}</td>
            <td><a href="${record.link}" target="_blank" rel="noopener noreferrer">Zobrazit / View</a></td>
          </tr>`;
        tbody.insertAdjacentHTML('beforeend', row);
      }
    }

    window.onload = loadData;
  </script>
</body>
</html>

